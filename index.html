<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>CS 4621: Final Project -- Music Visualizer</title>

  <!-- Bootstrap -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/cs4620.css" rel="stylesheet">
  <link href="css/jquery-ui.min.css" rel="stylesheet">
  <link href="css/jquery-ui.theme.min.css" rel="stylesheet">
  <link href="css/jquery-ui.structure.min.css" rel="stylesheet">

  <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous">
  </script>

  <script language="javascript" type="text/javascript" src="js/p5.js"></script>
  <script language="javascript" type="text/javascript" src="js/p5.sound.js"></script>
  <script language="javascript" type="text/javascript" src="js/gl-matrix-min.js"></script>
  <script language="javascript" type="text/javascript" src="js/preloadjs-0.6.2.min.js"></script>
  <script language="javascript" type="text/javascript" src="js/boilerplate.js"></script>
</head>

<body>

  <label for="js-song">Song:</label>
  <input type="file" id="js-song">
  <button id="play">Play</button>

  <div align="center">
    <canvas tabindex="1" id="webglCanvas" style="border: none; background-color: black;" width="800" height="600"></canvas>
  </div>

  <script id="vertexShader--basic" type="x-shader/x-vertex">
    attribute vec3 position;

    uniform mat4 projection;
    uniform mat4 toWorld;
    uniform mat4 toCam;

    void main() {
      gl_Position = projection * toCam * toWorld * vec4(position, 1.0);
    }
  </script>

  <script id="fragmentShader--basic" type="x-shader/x-fragment">
    precision highp float;
    // uniform vec3 color;
    
    vec3 color = vec3(1.0);
    void main() {
      gl_FragColor = vec4(color, 1.0);
    }
  </script>

  <script>

  // Scene Objects  ---------------------------------------------------

  // create particle object centered at [x], [y], [z] with scale [s]
  function createParticle(x, y, z, s) {
    var particle = {};
    
    // Instantiate particle
    particle.position = [x, y, z];
    particle.scale = [s, s, s];

    // Create [particle.toWorld] matrix
    updateToWorldMatrix(particle);

    return particle;
  }

  /*
   * create 2D sheet of particles with properties:
   * - [numX]
   * - [numY]
   * - [minX]
   * - [maxX]
   * - [minY]
   * - [maxY]
   */
  function createParticleSheet(numX, numY, minX, maxX, minY, maxY) {
    var width = maxX - minX;
    var height = maxY - minY;
    
    var particles = {};
    particles.list = [];
    particles.position = [0, 0, 0];
    particles.scale = [1, 1, 1];

    for (var i = 0; i < numX; i++) {
      particles.list[i] = [];
      for (var j = 0; j < numY; j++) {
        // Create particle
        var x = ((i / (numX-1)) * width) + minX;
        var y = ((j / (numY-1)) * height) + minY;
        particles.list[i][j] = createParticle(x, y, 0, 0.1);
      }
    }

    // Create [particles.toWorld]
    updateToWorldMatrix(particles);

    return particles;
  }

  /**
   * create the scene for our visualization
   * the [scene] object has the following fields:
   * - [camera]
   * - [particles]
   * - [shape]: shape for each particle
   */
  function createScene(camera, particles, shape) {
    var scene = {
      camera: camera,
      particles: particles,
      shape: shape
    };

    return scene;
  }

  /**
   * draw all the objects in the scene
   * [scene] has the following properties:
   * - [particles]
   *   - [list]
   *   - [toWorld]
   * - [camera]
   *   - [toWorld]
   *   - [projection]
   */
  function drawScene(gl, scene) {
    // Draw each particle
    for (var i = 0; i < particles.list.length; i++) {
      for (var j = 0; j < particles.list[i].length; j++) {
        var particle = particles.list[i][j];
        var toWorld = mat4.create();
        mat4.mul(toWorld, particles.toWorld, particle.toWorld);
        drawShape(gl, scene.shape, camera, toWorld);
      }
    }
  }

  /**
   * update [object.toWorld] matrix according to the [object] properties:
   * - [position]: array [x, y, z]
   * - [scale]: array [sx, sy, sz] or null
   */
  function updateToWorldMatrix(object) {
    // Create Translation matrix
    var [x, y, z] = object.position;
    var translation = vec3.fromValues(x,y,z);
    var T = mat4.create();
    mat4.fromTranslation(T, translation);

    // Create Scale Matrix
    var S = mat4.create();
    if (object.scale != null) {
      var [sx, sy, sz] = object.scale;
      var scale = vec3.fromValues(sx,sy,sz);
      mat4.fromScaling(S, scale);
    }
    
    // Update [object.toWorld] matrix
    object.toWorld = mat4.create();
    mat4.mul(object.toWorld, T, S);

    return object;
  }

  // WebGL --------------------------------------------------------------
  var gl = initializeWebGL($("#webglCanvas"));
  var basic_shader = createGlslProgram(gl, "vertexShader--basic", "fragmentShader--basic");
  var fft = null;
  var sound = null;

  // Create Projection Matrix (Perspective Camera)
  var perspectiveMatrix = mat4.create();
  var fovy = (45.0 / 180.0) * Math.PI;
  var aspect = $("#webglCanvas").attr("width") / $("#webglCanvas").attr("height");
  var near = 0.1;
  var far = 100.0;
  mat4.perspective(perspectiveMatrix, fovy, aspect, near, far);

  // Create Camera
  var camera = {};
  camera.position = [0.0, 0.0, 5.0];
  camera.projection = perspectiveMatrix;
  updateToWorldMatrix(camera);

  // Create particles
  var particles = createParticleSheet(10, 10, -1, 1, -1, 1);

  // Create shape
  var cube = createShape(gl, basic_shader, cubeData, false);

  // Create scene
  var scene = createScene(camera, particles, cube);

  // UpdateWebGL ----------------------------------------------------------
  function updateWebGL(time) {
    gl.clearColor(0.15, 0.2, 0.5, 1.0);
    gl.clear(gl.COLOR_BUFFER_BIT);
    
    // TODO: Update Scene based on song data
    if (fft != null && sound != null && sound.isPlaying()) {
      //console.log("fft: " + fft);
      console.log("fft.waveform: " + fft.waveform()[0]);
      var s = Math.abs(fft.waveform()[0]) * 20;
      scene.particles.scale = [s, s, s];
      updateToWorldMatrix(scene.particles);
    }

    // Draw Scene
    drawScene(gl, scene);

    // Reschedule the next frame.
    window.requestAnimationFrame(updateWebGL);
  }
  window.requestAnimationFrame(updateWebGL);


  // NOT SURE WE WANT TO GO ON CHANGE, PROBABLY ON BUTTON PRESS, BUT TESTING FOR NOW

  $('#js-song').on('change', function() {

      var url = $(this).val();
      var song = url.split('\\').pop();
      console.log(song);

      var s = function(p) {

        p.preload = function() {
          p.soundFormats('m4a');
          sound = p.loadSound('assets/'+song);
        }

        p.setup = function() {
          fft = new p5.FFT();
          console.log("SETUP");
          sound.amp(0.2);
        }

        p.draw = function() {
          var spectrum = fft.analyze();
          var waveform = fft.waveform();
        }

        p.togglePlay = function() {
          if ( sound.isPlaying() ) {
            sound.pause();
            $('#play').html('Play');
          } else {
            sound.play();
            $('#play').html('Pause');
          }
        }

        $('#play').on('click', p.togglePlay);

      }

      var myp5 = new p5(s);

  });

  </script>
</body>

</html>
